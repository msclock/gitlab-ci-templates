# Job for scanning for vulnerabilities with Google's OSV Scanner tool.

osv_scanner:
  image:
    name: ghcr.io/google/osv-scanner:v1.3.6@sha256:6a6477b8d599082dedf9216fc693355e6e1d1b5906698a6e3675db608f12bccf
    entrypoint: ['']
  stage: test
  # Uses lockfile, so does not need (or want) dependencies
  needs: []
  allow_failure: true
  script:
    # Run scan with output to console, and if it fails re-run with JSON output.
    - /osv-scanner --format table . || /osv-scanner --format json . > osv-scanner-results.json
  after_script:
    # Add artificial metrics report to collect release evidence
    - echo 'osv_scanner run' > metrics.txt
  artifacts:
    when: on_failure
    expose_as: OSV Scanner Report
    paths:
      - osv-scanner-results.json
    # Add artificial metrics report to collect release evidence
    reports:
      metrics: metrics.txt
