.make_changes_template:
  after_script: |
    if [[ -z "$ACCESS_TOKEN" ]]; then
        echo "The job has no access token found." >>/dev/stderr
        echo "To enable automatic to commit changes, please create a project access token with repository write scope and set the ACCESS_TOKEN variable" >/dev/stderr
        exit 1
    fi

    # Prepare config for git
    if [[ -n "$CI_COMMIT_BRANCH" ]]; then
        git remote set-url origin "https://gitlab-ci-token:${ACCESS_TOKEN:-$CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        git checkout $CI_COMMIT_BRANCH
    fi
    if [[ -n "$CI_MERGE_REQUEST_IID" ]]; then
        git remote set-url origin "https://gitlab-ci-token:${ACCESS_TOKEN:-$CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_MERGE_REQUEST_SOURCE_PROJECT_PATH}.git"
    fi

    git config --global user.name "GitLab Ci"
    git config --global user.email "gitlab-ci@no-reply.com"

    if [[ -n "$MAKE_PR" ]]; then
        temp_branch=temp_black_${CI_COMMIT_SHA:0:12}
        git checkout -b "$temp_branch"
    fi

    git add -u .
    git commit -m ${MAKE_AUTOMATED_MSG:-"ci: automated commit changes from CI job"} -m "job url:$CI_JOB_URL"
    if [[ -n "$MAKE_PR"]]; then
        git push origin "$temp_branch"
        curl --header "PRIVATE-TOKEN: $ACCESS_TOKEN" \
            --request POST "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/merge_requests" \
            --form "source_branch=$temp_branch" \
            --form "target_branch=$CI_COMMIT_REF_NAME" \
            --form "title=PR from $temp_branch"
    elif [[ -n "$CI_COMMIT_BRANCH" ]]; then
        git push origin HEAD:"$CI_COMMIT_BRANCH"
    elif [[ -n "$CI_MERGE_REQUEST_IID" ]]; then
        git push origin HEAD:"$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    fi

    if [[ -n "$MAKE_PR"]]; then
        exit 0
    else
        exit 1
    fi


.correct_code_state:
  script: |
    set -x

    status=0
    $check_command || status=$?
    if [[ $status -ne 0 ]]; then
        $correct_command
    fi

    # Exit using status without CI envs
    if [[ -z "$CI" ]]; then
        echo 'finish formatting locally'
        exit $status
    fi